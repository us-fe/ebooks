import{_ as n,d as s}from"./app.a957722f.js";const a={},t=s(`<h1 id="you-don-t-know-js-async-performance" tabindex="-1"><a class="header-anchor" href="#you-don-t-know-js-async-performance" aria-hidden="true">#</a> You Don&#39;t Know JS: Async &amp; Performance</h1><h1 id="appendix-b-advanced-async-patterns" tabindex="-1"><a class="header-anchor" href="#appendix-b-advanced-async-patterns" aria-hidden="true">#</a> Appendix B: Advanced Async Patterns</h1><p>Appendix A introduced the <em>asynquence</em> library for sequence-oriented async flow control, primarily based on Promises and generators.</p><p>Now we&#39;ll explore other advanced asynchronous patterns built on top of that existing understanding and functionality, and see how <em>asynquence</em> makes those sophisticated async techniques easy to mix and match in our programs without needing lots of separate libraries.</p><h2 id="iterable-sequences" tabindex="-1"><a class="header-anchor" href="#iterable-sequences" aria-hidden="true">#</a> Iterable Sequences</h2><p>We introduced <em>asynquence</em>&#39;s iterable sequences in the previous appendix, but we want to revisit them in more detail.</p><p>To refresh, recall:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> domready <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

domready<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// DOM is ready</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ..</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> domready<span class="token punctuation">.</span>next <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Now, let&#39;s define a sequence of multiple steps as an iterable sequence:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> steps <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

steps
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP1</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP2</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP3</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

steps<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 16</span>
steps<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">16</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 19</span>
steps<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">19</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 76</span>
steps<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">;</span>		<span class="token comment">// true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>As you can see, an iterable sequence is a standard-compliant <em>iterator</em> (see Chapter 4). So, it can be iterated with an ES6 <code>for..of</code> loop, just like a generator (or any other <em>iterable</em>) can:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> steps <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

steps
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> steps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2 4 6 8 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Beyond the event triggering example shown in the previous appendix, iterable sequences are interesting because in essence they can be seen as a stand-in for generators or Promise chains, but with even more flexibility.</p><p>Consider a multiple Ajax request example -- we&#39;ve seen the same scenario in Chapters 3 and 4, both as a Promise chain and as a generator, respectively -- expressed as an iterable sequence:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// sequence-aware ajax</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span> ajax <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span>
	<span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP1</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">var</span> url <span class="token operator">=</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span>

	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP2</span><span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
			<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span>

	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP3</span><span class="token punctuation">(</span><span class="token parameter">r1<span class="token punctuation">,</span>r2</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> r1 <span class="token operator">+</span> r2<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>The iterable sequence expresses a sequential series of (sync or async) steps that looks awfully similar to a Promise chain -- in other words, it&#39;s much cleaner looking than just plain nested callbacks, but not quite as nice as the <code>yield</code>-based sequential syntax of generators.</p><p>But we pass the iterable sequence into <code>ASQ#runner(..)</code>, which runs it to completion the same as if it was a generator. The fact that an iterable sequence behaves essentially the same as a generator is notable for a couple of reasons.</p><p>First, iterable sequences are kind of a pre-ES6 equivalent to a certain subset of ES6 generators, which means you can either author them directly (to run anywhere), or you can author ES6 generators and transpile/convert them to iterable sequences (or Promise chains for that matter!).</p><p>Thinking of an async-run-to-completion generator as just syntactic sugar for a Promise chain is an important recognition of their isomorphic relationship.</p><p>Before we move on, we should note that the previous snippet could have been expressed in <em>asynquence</em> as:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token comment">/*STEP 1*/</span> request <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP2</span><span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP3</span><span class="token punctuation">(</span><span class="token parameter">r1<span class="token punctuation">,</span>r2</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> r1 <span class="token operator">+</span> r2<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Moreover, step 2 could have even been expressed as:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span> <span class="token function">STEP2a</span><span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span>resp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span> done <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span> <span class="token function">STEP2b</span><span class="token punctuation">(</span><span class="token parameter">done<span class="token punctuation">,</span>resp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span> done <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>So, why would we go to the trouble of expressing our flow control as an iterable sequence in a <code>ASQ#runner(..)</code> step, when it seems like a simpler/flatter <em>asyquence</em> chain does the job well?</p><p>Because the iterable sequence form has an important trick up its sleeve that gives us more capability. Read on.</p><h3 id="extending-iterable-sequences" tabindex="-1"><a class="header-anchor" href="#extending-iterable-sequences" aria-hidden="true">#</a> Extending Iterable Sequences</h3><p>Generators, normal <em>asynquence</em> sequences, and Promise chains, are all <strong>eagerly evaluated</strong> -- whatever flow control is expressed initially <em>is</em> the fixed flow that will be followed.</p><p>However, iterable sequences are <strong>lazily evaluated</strong>, which means that during execution of the iterable sequence, you can extend the sequence with more steps if desired.</p><p><strong>Note:</strong> You can only append to the end of an iterable sequence, not inject into the middle of the sequence.</p><p>Let&#39;s first look at a simpler (synchronous) example of that capability to get familiar with it:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>

	<span class="token comment">// should we keep extending?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		isq<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> double <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// setup single-step iterable sequence</span>
<span class="token keyword">var</span> isq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> double <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">(</span>ret <span class="token operator">=</span> isq<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ret<span class="token punctuation">.</span>done<span class="token punctuation">;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	v <span class="token operator">=</span> ret<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>The iterable sequence starts out with only one defined step (<code>isq.then(double)</code>), but the sequence keeps extending itself under certain conditions (<code>x &lt; 500</code>). Both <em>asynquence</em> sequences and Promise chains technically <em>can</em> do something similar, but we&#39;ll see in a little bit why their capability is insufficient.</p><p>Though this example is rather trivial and could otherwise be expressed with a <code>while</code> loop in a generator, we&#39;ll consider more sophisticated cases.</p><p>For instance, you could examine the response from an Ajax request and if it indicates that more data is needed, you conditionally insert more steps into the iterable sequence to make the additional request(s). Or you could conditionally add a value-formatting step to the end of your Ajax handling.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> steps <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">iterable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP1</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> url <span class="token operator">=</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">;</span>

	<span class="token comment">// was an additional formatting step provided?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>format<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		steps<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>format <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP2</span><span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// add another Ajax request to the sequence?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">x1</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> resp <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		steps<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP5</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>
				<span class="token string">&quot;http://some.url.4/?v=&quot;</span> <span class="token operator">+</span> text
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token constant">STEP3</span><span class="token punctuation">(</span><span class="token parameter">r1<span class="token punctuation">,</span>r2</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> r1 <span class="token operator">+</span> r2<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>You can see in two different places where we conditionally extend <code>steps</code> with <code>steps.then(..)</code>. And to run this <code>steps</code> iterable sequence, we just wire it into our main program flow with an <em>asynquence</em> sequence (called <code>main</code> here) using <code>ASQ#runner(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> main <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">,</span>
	<span class="token function-variable function">format</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token constant">STEP4</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span> steps <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Can the flexibility (conditional behavior) of the <code>steps</code> iterable sequence be expressed with a generator? Kind of, but we have to rearrange the logic in a slightly awkward way:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">steps</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// **STEP 1**</span>
	<span class="token keyword">var</span> resp <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// **STEP 2**</span>
	<span class="token keyword">var</span> rvals <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> resp <span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// **STEP 3**</span>
	<span class="token keyword">var</span> text <span class="token operator">=</span> rvals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> rvals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// **STEP 4**</span>
	<span class="token comment">// was an additional formatting step provided?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>format<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		text <span class="token operator">=</span> <span class="token keyword">yield</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// **STEP 5**</span>
	<span class="token comment">// need another Ajax request added to the sequence?</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">foobar</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> resp <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>
			<span class="token string">&quot;http://some.url.4/?v=&quot;</span> <span class="token operator">+</span> text
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// note: \`*steps()\` can be run by the same \`ASQ\` sequence</span>
<span class="token comment">// as \`steps\` was previously</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>Setting aside the already identified benefits of the sequential, synchronous-looking syntax of generators (see Chapter 4), the <code>steps</code> logic had to be reordered in the <code>*steps()</code> generator form, to fake the dynamicism of the extendable iterable sequence <code>steps</code>.</p><p>What about expressing the functionality with Promises or sequences, though? You <em>can</em> do something like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> steps <span class="token operator">=</span> <span class="token function">something</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">.</span><span class="token punctuation">.</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// ..</span>

	<span class="token comment">// extending the chain, right?</span>
	steps <span class="token operator">=</span> steps<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// ..</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The problem is subtle but important to grasp. So, consider trying to wire up our <code>steps</code> Promise chain into our main program flow -- this time expressed with Promises instead of <em>asynquence</em>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> main <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">,</span>
	<span class="token function-variable function">format</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token constant">STEP4</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">.</span><span class="token punctuation">.</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> steps<span class="token punctuation">;</span>			<span class="token comment">// hint!</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Can you spot the problem now? Look closely!</p><p>There&#39;s a race condition for sequence steps ordering. When you <code>return steps</code>, at that moment <code>steps</code> <em>might</em> be the originally defined promise chain, or it might now point to the extended promise chain via the <code>steps = steps.then(..)</code> call, depending on what order things happen.</p><p>Here are the two possible outcomes:</p><ul><li>If <code>steps</code> is still the original promise chain, once it&#39;s later &quot;extended&quot; by <code>steps = steps.then(..)</code>, that extended promise on the end of the chain is <strong>not</strong> considered by the <code>main</code> flow, as it&#39;s already tapped the <code>steps</code> chain. This is the unfortunately limiting <strong>eager evaluation</strong>.</li><li>If <code>steps</code> is already the extended promise chain, it works as we expect in that the extended promise is what <code>main</code> taps.</li></ul><p>Other than the obvious fact that a race condition is intolerable, the first case is the concern; it illustrates <strong>eager evaluation</strong> of the promise chain. By contrast, we easily extended the iterable sequence without such issues, because iterable sequences are <strong>lazily evaluated</strong>.</p><p>The more dynamic you need your flow control, the more iterable sequences will shine.</p><p><strong>Tip:</strong> Check out more information and examples of iterable sequences on the <em>asynquence</em> site (https://github.com/getify/asynquence/blob/master/README.md#iterable-sequences).</p><h2 id="event-reactive" tabindex="-1"><a class="header-anchor" href="#event-reactive" aria-hidden="true">#</a> Event Reactive</h2><p>It should be obvious from (at least!) Chapter 3 that Promises are a very powerful tool in your async toolbox. But one thing that&#39;s clearly lacking is in their capability to handle streams of events, as a Promise can only be resolved once. And frankly, this exact same weakness is true of plain <em>asynquence</em> sequences, as well.</p><p>Consider a scenario where you want to fire off a series of steps every time a certain event is fired. A single Promise or sequence cannot represent all occurrences of that event. So, you have to create a whole new Promise chain (or sequence) for <em>each</em> event occurrence, such as:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>listener<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span> <span class="token string">&quot;foobar&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token comment">// create a new event handling promise chain</span>
	<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// ..</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>The base functionality we need is present in this approach, but it&#39;s far from a desirable way to express our intended logic. There are two separate capabilities conflated in this paradigm: the event listening, and responding to the event; separation of concerns would implore us to separate out these capabilities.</p><p>The carefully observant reader will see this problem as somewhat symmetrical to the problems we detailed with callbacks in Chapter 2; it&#39;s kind of an inversion of control problem.</p><p>Imagine uninverting this paradigm, like so:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> observable <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span> <span class="token string">&quot;foobar&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>
observable
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// elsewhere</span>
observable
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The <code>observable</code> value is not exactly a Promise, but you can <em>observe</em> it much like you can observe a Promise, so it&#39;s closely related. In fact, it can be observed many times, and it will send out notifications every time its event (<code>&quot;foobar&quot;</code>) occurs.</p><p><strong>Tip:</strong> This pattern I&#39;ve just illustrated is a <strong>massive simplification</strong> of the concepts and motivations behind reactive programming (aka RP), which has been implemented/expounded upon by several great projects and languages. A variation on RP is functional reactive programming (FRP), which refers to applying functional programming techniques (immutability, referential integrity, etc.) to streams of data. &quot;Reactive&quot; refers to spreading this functionality out over time in response to events. The interested reader should consider studying &quot;Reactive Observables&quot; in the fantastic &quot;Reactive Extensions&quot; library (&quot;RxJS&quot; for JavaScript) by Microsoft (http://rxjs.codeplex.com/); it&#39;s much more sophisticated and powerful than I&#39;ve just shown. Also, Andre Staltz has an excellent write-up (https://gist.github.com/staltz/868e7e9bc2a7b8c1f754) that pragmatically lays out RP in concrete examples.</p><h3 id="es7-observables" tabindex="-1"><a class="header-anchor" href="#es7-observables" aria-hidden="true">#</a> ES7 Observables</h3><p>At the time of this writing, there&#39;s an early ES7 proposal for a new data type called &quot;Observable&quot; (https://github.com/jhusain/asyncgenerator#introducing-observable), which in spirit is similar to what we&#39;ve laid out here, but is definitely more sophisticated.</p><p>The notion of this kind of Observable is that the way you &quot;subscribe&quot; to the events from a stream is to pass in a generator -- actually the <em>iterator</em> is the interested party -- whose <code>next(..)</code> method will be called for each event.</p><p>You could imagine it sort of like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`someEventStream\` is a stream of events, like from</span>
<span class="token comment">// mouse clicks, and the like.</span>

<span class="token keyword">var</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span> someEventStream<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">var</span> evt <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> evt <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>The generator you pass in will <code>yield</code> pause the <code>while</code> loop waiting for the next event. The <em>iterator</em> attached to the generator instance will have its <code>next(..)</code> called each time <code>someEventStream</code> has a new event published, and so that event data will resume your generator/<em>iterator</em> with the <code>evt</code> data.</p><p>In the subscription to events functionality here, it&#39;s the <em>iterator</em> part that matters, not the generator. So conceptually you could pass in practically any iterable, including <code>ASQ.iterable()</code> iterable sequences.</p><p>Interestingly, there are also proposed adapters to make it easy to construct Observables from certain types of streams, such as <code>fromEvent(..)</code> for DOM events. If you look at a suggested implementation of <code>fromEvent(..)</code> in the earlier linked ES7 proposal, it looks an awful lot like the <code>ASQ.react(..)</code> we&#39;ll see in the next section.</p><p>Of course, these are all early proposals, so what shakes out may very well look/behave differently than shown here. But it&#39;s exciting to see the early alignments of concepts across different libraries and language proposals!</p><h3 id="reactive-sequences" tabindex="-1"><a class="header-anchor" href="#reactive-sequences" aria-hidden="true">#</a> Reactive Sequences</h3><p>With that crazy brief summary of Observables (and F/RP) as our inspiration and motivation, I will now illustrate an adaptation of a small subset of &quot;Reactive Observables,&quot; which I call &quot;Reactive Sequences.&quot;</p><p>First, let&#39;s start with how to create an Observable, using an <em>asynquence</em> plug-in utility called <code>react(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> observable <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	listener<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span> <span class="token string">&quot;foobar&quot;</span><span class="token punctuation">,</span> next <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Now, let&#39;s see how to define a sequence that &quot;reacts&quot; -- in F/RP, this is typically called &quot;subscribing&quot; -- to that <code>observable</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>observable
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>So, you just define the sequence by chaining off the Observable. That&#39;s easy, huh?</p><p>In F/RP, the stream of events typically channels through a set of functional transforms, like <code>scan(..)</code>, <code>map(..)</code>, <code>reduce(..)</code>, and so on. With reactive sequences, each event channels through a new instance of the sequence. Let&#39;s look at a more concrete example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span> <span class="token string">&quot;mybtn&quot;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> btnID <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1/?id=&quot;</span> <span class="token operator">+</span> btnID
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>The &quot;reactive&quot; portion of the reactive sequence comes from assigning one or more event handlers to invoke the event trigger (calling <code>next(..)</code>).</p><p>The &quot;sequence&quot; portion of the reactive sequence is exactly like the sequences we&#39;ve already explored: each step can be whatever asynchronous technique makes sense, from continuation callback to Promise to generator.</p><p>Once you set up a reactive sequence, it will continue to initiate instances of the sequence as long as the events keep firing. If you want to stop a reactive sequence, you can call <code>stop()</code>.</p><p>If a reactive sequence is <code>stop()</code>&#39;d, you likely want the event handler(s) to be unregistered as well; you can register a teardown handler for this purpose:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">next<span class="token punctuation">,</span>registerTeardown</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span> <span class="token string">&quot;mybtn&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// will be called once \`sq.stop()\` is called</span>
	<span class="token function">registerTeardown</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		btn<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>
sq<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>Note:</strong> The <code>this</code> binding reference inside the <code>setup(..)</code> handler is the same <code>sq</code> reactive sequence, so you can use the <code>this</code> reference to add to the reactive sequence definition, call methods like <code>stop()</code>, and so on.</p><p>Here&#39;s an example from the Node.js world, using reactive sequences to handle incoming HTTP requests:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// reactive observer</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">next<span class="token punctuation">,</span>registerTeardown</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	server<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span> <span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> next <span class="token punctuation">)</span><span class="token punctuation">;</span>
	server<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">registerTeardown</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		server<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span> <span class="token string">&quot;request&quot;</span><span class="token punctuation">,</span> next <span class="token punctuation">)</span><span class="token punctuation">;</span>
		server<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>stop <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// respond to requests</span>
request
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> pullFromDatabase <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// node teardown</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span> <span class="token string">&quot;SIGINT&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>stop <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>The <code>next(..)</code> trigger can also adapt to node streams easily, using <code>onStream(..)</code> and <code>unStream(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> fstream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span> <span class="token string">&quot;/some/file&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// pipe the stream&#39;s &quot;data&quot; event to \`next(..)\`</span>
	next<span class="token punctuation">.</span><span class="token function">onStream</span><span class="token punctuation">(</span> fstream <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// listen for the end of the stream</span>
	fstream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span> <span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		next<span class="token punctuation">.</span><span class="token function">unStream</span><span class="token punctuation">(</span> fstream <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>You can also use sequence combinations to compose multiple reactive sequence streams:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> sq1 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sq2 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">seq</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sq3 <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">gate</span><span class="token punctuation">(</span>
	sq1<span class="token punctuation">,</span>
	sq2
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>The main takeaway is that <code>ASQ.react(..)</code> is a lightweight adaptation of F/RP concepts, enabling the wiring of an event stream to a sequence, hence the term &quot;reactive sequence.&quot; Reactive sequences are generally capable enough for basic reactive uses.</p><p><strong>Note:</strong> Here&#39;s an example of using <code>ASQ.react(..)</code> in managing UI state (http://jsbin.com/rozipaki/6/edit?js,output), and another example of handling HTTP request/response streams with <code>ASQ.react(..)</code> (https://gist.github.com/getify/bba5ec0de9d6047b720e).</p><h2 id="generator-coroutine" tabindex="-1"><a class="header-anchor" href="#generator-coroutine" aria-hidden="true">#</a> Generator Coroutine</h2><p>Hopefully Chapter 4 helped you get pretty familiar with ES6 generators. In particular, we want to revisit the &quot;Generator Concurrency&quot; discussion, and push it even further.</p><p>We imagined a <code>runAll(..)</code> utility that could take two or more generators and run them concurrently, letting them cooperatively <code>yield</code> control from one to the next, with optional message passing.</p><p>In addition to being able to run a single generator to completion, the <code>ASQ#runner(..)</code> we discussed in Appendix A is a similar implementation of the concepts of <code>runAll(..)</code>, which can run multiple generators concurrently to completion.</p><p>So let&#39;s see how we can implement the concurrent Ajax scenario from Chapter 4:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span>
	<span class="token string">&quot;http://some.url.2&quot;</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span> token<span class="token punctuation">;</span>

		<span class="token keyword">var</span> url1 <span class="token operator">=</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;http://some.url.1&quot;</span>

		<span class="token comment">// clear out messages to start fresh</span>
		token<span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> url1 <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span> token<span class="token punctuation">;</span>

		token<span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">yield</span> p1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">var</span> url2 <span class="token operator">=</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;http://some.url.2&quot;</span>

		<span class="token comment">// message pass and transfer control</span>
		token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">;</span>
		<span class="token keyword">yield</span> token<span class="token punctuation">;</span>

		<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> url2 <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span> token<span class="token punctuation">;</span>

		token<span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">yield</span> p2 <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// pass along results to next sequence step</span>
		<span class="token keyword">return</span> token<span class="token punctuation">.</span>messages<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// \`res[0]\` comes from &quot;http://some.url.1&quot;</span>
	<span class="token comment">// \`res[1]\` comes from &quot;http://some.url.2&quot;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>The main differences between <code>ASQ#runner(..)</code> and <code>runAll(..)</code> are as follows:</p><ul><li>Each generator (coroutine) is provided an argument we call <code>token</code>, which is the special value to <code>yield</code> when you want to explicitly transfer control to the next coroutine.</li><li><code>token.messages</code> is an array that holds any messages passed in from the previous sequence step. It&#39;s also a data structure that you can use to share messages between coroutines.</li><li><code>yield</code>ing a Promise (or sequence) value does not transfer control, but instead pauses the coroutine processing until that value is ready.</li><li>The last <code>return</code>ed or <code>yield</code>ed value from the coroutine processing run will be forward passed to the next step in the sequence.</li></ul><p>It&#39;s also easy to layer helpers on top of the base <code>ASQ#runner(..)</code> functionality to suit different uses.</p><h3 id="state-machines" tabindex="-1"><a class="header-anchor" href="#state-machines" aria-hidden="true">#</a> State Machines</h3><p>One example that may be familiar to many programmers is state machines. You can, with the help of a simple cosmetic utility, create an easy-to-express state machine processor.</p><p>Let&#39;s imagine such a utility. We&#39;ll call it <code>state(..)</code>, and will pass it two arguments: a state value and a generator that handles that state. <code>state(..)</code> will do the dirty work of creating and returning an adapter generator to pass to <code>ASQ#runner(..)</code>.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span>handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// make a coroutine handler for this state</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// state transition handler</span>
		<span class="token keyword">function</span> <span class="token function">transition</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> to<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// set initial state (if none set yet)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// keep going until final state (false) is reached</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// current state matches this handler?</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// delegate to state handler</span>
				<span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">handler</span><span class="token punctuation">(</span> transition <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// transfer control to another state handler?</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">yield</span> token<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>If you look closely, you&#39;ll see that <code>state(..)</code> returns back a generator that accepts a <code>token</code>, and then it sets up a <code>while</code> loop that will run until the state machine reaches its final state (which we arbitrarily pick as the <code>false</code> value); that&#39;s exactly the kind of generator we want to pass to <code>ASQ#runner(..)</code>!</p><p>We also arbitrarily reserve the <code>token.messages[0]</code> slot as the place where the current state of our state machine will be tracked, which means we can even seed the initial state as the value passed in from the previous step in the sequence.</p><p>How do we use the <code>state(..)</code> helper along with <code>ASQ#runner(..)</code>?</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> prevState<span class="token punctuation">;</span>

<span class="token constant">ASQ</span><span class="token punctuation">(</span>
	<span class="token comment">/* optional: initial state value */</span>
	<span class="token number">2</span>
<span class="token punctuation">)</span>
<span class="token comment">// run our state machine</span>
<span class="token comment">// transitions: 2 -&gt; 3 -&gt; 1 -&gt; 3 -&gt; false</span>
<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span>
	<span class="token comment">// state \`1\` handler</span>
	<span class="token function">state</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">stateOne</span><span class="token punctuation">(</span><span class="token parameter">transition</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;in state 1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		prevState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">yield</span> <span class="token function">transition</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// goto state \`3\`</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token comment">// state \`2\` handler</span>
	<span class="token function">state</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">stateTwo</span><span class="token punctuation">(</span><span class="token parameter">transition</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;in state 2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		prevState <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">yield</span> <span class="token function">transition</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// goto state \`3\`</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token comment">// state \`3\` handler</span>
	<span class="token function">state</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">stateThree</span><span class="token punctuation">(</span><span class="token parameter">transition</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;in state 3&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>prevState <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			prevState <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
			<span class="token keyword">yield</span> <span class="token function">transition</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// goto state \`1\`</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// all done!</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">yield</span> <span class="token string">&quot;That&#39;s all folks!&quot;</span><span class="token punctuation">;</span>

			prevState <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
			<span class="token keyword">yield</span> <span class="token function">transition</span><span class="token punctuation">(</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// terminal state</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment">// state machine complete, so move on</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// That&#39;s all folks!</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>It&#39;s important to note that the <code>*stateOne(..)</code>, <code>*stateTwo(..)</code>, and <code>*stateThree(..)</code> generators themselves are reinvoked each time that state is entered, and they finish when you <code>transition(..)</code> to another value. While not shown here, of course these state generator handlers can be asynchronously paused by <code>yield</code>ing Promises/sequences/thunks.</p><p>The underneath hidden generators produced by the <code>state(..)</code> helper and actually passed to <code>ASQ#runner(..)</code> are the ones that continue to run concurrently for the length of the state machine, and each of them handles cooperatively <code>yield</code>ing control to the next, and so on.</p><p><strong>Note:</strong> See this &quot;ping pong&quot; example (http://jsbin.com/qutabu/1/edit?js,output) for more illustration of using cooperative concurrency with generators driven by <code>ASQ#runner(..)</code>.</p><h2 id="communicating-sequential-processes-csp" tabindex="-1"><a class="header-anchor" href="#communicating-sequential-processes-csp" aria-hidden="true">#</a> Communicating Sequential Processes (CSP)</h2><p>&quot;Communicating Sequential Processes&quot; (CSP) was first described by C. A. R. Hoare in a 1978 academic paper (http://dl.acm.org/citation.cfm?doid=359576.359585), and later in a 1985 book (http://www.usingcsp.com/) of the same name. CSP describes a formal method for concurrent &quot;processes&quot; to interact (aka &quot;communicate&quot;) during processing.</p><p>You may recall that we examined concurrent &quot;processes&quot; back in Chapter 1, so our exploration of CSP here will build upon that understanding.</p><p>Like most great concepts in computer science, CSP is heavily steeped in academic formalism, expressed as a process algebra. However, I suspect symbolic algebra theorems won&#39;t make much practical difference to the reader, so we will want to find some other way of wrapping our brains around CSP.</p><p>I will leave much of the formal description and proof of CSP to Hoare&#39;s writing, and to many other fantastic writings since. Instead, we will try to just briefly explain the idea of CSP in as un-academic and hopefully intuitively understandable a way as possible.</p><h3 id="message-passing" tabindex="-1"><a class="header-anchor" href="#message-passing" aria-hidden="true">#</a> Message Passing</h3><p>The core principle in CSP is that all communication/interaction between otherwise independent processes must be through formal message passing. Perhaps counter to your expectations, CSP message passing is described as a synchronous action, where the sender process and the receiver process have to mutually be ready for the message to be passed.</p><p>How could such synchronous messaging possibly be related to asynchronous programming in JavaScript?</p><p>The concreteness of relationship comes from the nature of how ES6 generators are used to produce synchronous-looking actions that under the covers can indeed either be synchronous or (more likely) asynchronous.</p><p>In other words, two or more concurrently running generators can appear to synchronously message each other while preserving the fundamental asynchrony of the system because each generator&#39;s code is paused (aka &quot;blocked&quot;) waiting on resumption of an asynchronous action.</p><p>How does this work?</p><p>Imagine a generator (aka &quot;process&quot;) called &quot;A&quot; that wants to send a message to generator &quot;B.&quot; First, &quot;A&quot; <code>yield</code>s the message (thus pausing &quot;A&quot;) to be sent to &quot;B.&quot; When &quot;B&quot; is ready and takes the message, &quot;A&quot; is then resumed (unblocked).</p><p>Symmetrically, imagine a generator &quot;A&quot; that wants a message <strong>from</strong> &quot;B.&quot; &quot;A&quot; <code>yield</code>s its request (thus pausing &quot;A&quot;) for the message from &quot;B,&quot; and once &quot;B&quot; sends a message, &quot;A&quot; takes the message and is resumed.</p><p>One of the more popular expressions of this CSP message passing theory comes from ClojureScript&#39;s core.async library, and also from the <em>go</em> language. These takes on CSP embody the described communication semantics in a conduit that is opened between processes called a &quot;channel.&quot;</p><p><strong>Note:</strong> The term <em>channel</em> is used in part because there are modes in which more than one value can be sent at once into the &quot;buffer&quot; of the channel; this is similar to what you may think of as a stream. We won&#39;t go into depth about it here, but it can be a very powerful technique for managing streams of data.</p><p>In the simplest notion of CSP, a channel that we create between &quot;A&quot; and &quot;B&quot; would have a method called <code>take(..)</code> for blocking to receive a value, and a method called <code>put(..)</code> for blocking to send a value.</p><p>This might look like:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span> ch <span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> <span class="token string">&quot;Hello World&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;message sent&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">run</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Hello World</span>
<span class="token comment">// &quot;message sent&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Compare this structured, synchronous(-looking) message passing interaction to the informal and unstructured message sharing that <code>ASQ#runner(..)</code> provides through the <code>token.messages</code> array and cooperative <code>yield</code>ing. In essence, <code>yield put(..)</code> is a single operation that both sends the value and pauses execution to transfer control, whereas in earlier examples we did those as separate steps.</p><p>Moreover, CSP stresses that you don&#39;t really explicitly &quot;transfer control,&quot; but rather you design your concurrent routines to block expecting either a value received from the channel, or to block expecting to try to send a message on the channel. The blocking around receiving or sending messages is how you coordinate sequencing of behavior between the coroutines.</p><p><strong>Note:</strong> Fair warning: this pattern is very powerful but it&#39;s also a little mind twisting to get used to at first. You will want to practice this a bit to get used to this new way of thinking about coordinating your concurrency.</p><p>There are several great libraries that have implemented this flavor of CSP in JavaScript, most notably &quot;js-csp&quot; (https://github.com/ubolonton/js-csp), which James Long (http://twitter.com/jlongster) forked (https://github.com/jlongster/js-csp) and has written extensively about (http://jlongster.com/Taming-the-Asynchronous-Beast-with-CSP-in-JavaScript). Also, it cannot be stressed enough how amazing the many writings of David Nolen (http://twitter.com/swannodette) are on the topic of adapting ClojureScript&#39;s go-style core.async CSP into JS generators (http://swannodette.github.io/2013/08/24/es6-generators-and-csp).</p><h3 id="asynquence-csp-emulation" tabindex="-1"><a class="header-anchor" href="#asynquence-csp-emulation" aria-hidden="true">#</a> asynquence CSP emulation</h3><p>Because we&#39;ve been discussing async patterns here in the context of my <em>asynquence</em> library, you might be interested to see that we can fairly easily add an emulation layer on top of <code>ASQ#runner(..)</code> generator handling as a nearly perfect porting of the CSP API and behavior. This emulation layer ships as an optional part of the &quot;asynquence-contrib&quot; package alongside <em>asynquence</em>.</p><p>Very similar to the <code>state(..)</code> helper from earlier, <code>ASQ.csp.go(..)</code> takes a generator -- in go/core.async terms, it&#39;s known as a goroutine -- and adapts it to use with <code>ASQ#runner(..)</code> by returning a new generator.</p><p>Instead of being passed a <code>token</code>, your goroutine receives an initially created channel (<code>ch</code> below) that all goroutines in this run will share. You can create more channels (which is often quite helpful!) with <code>ASQ.csp.chan(..)</code>.</p><p>In CSP, we model all asynchrony in terms of blocking on channel messages, rather than blocking waiting for a Promise/sequence/thunk to complete.</p><p>So, instead of <code>yield</code>ing the Promise returned from <code>request(..)</code>, <code>request(..)</code> should return a channel that you <code>take(..)</code> a value from. In other words, a single-value channel is roughly equivalent in this context/usage to a Promise/sequence.</p><p>Let&#39;s first make a channel-aware version of <code>request(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ajax</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// \`putAsync(..)\` is a version of \`put(..)\` that</span>
		<span class="token comment">// can be used outside of a generator. It returns</span>
		<span class="token comment">// a promise for the operation&#39;s completion. We</span>
		<span class="token comment">// don&#39;t use that promise here, but we could if</span>
		<span class="token comment">// we needed to be notified when the value had</span>
		<span class="token comment">// been \`take(..)\`n.</span>
		<span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">putAsync</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> content <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>From Chapter 3, &quot;promisory&quot; is a Promise-producing utility, &quot;thunkory&quot; from Chapter 4 is a thunk-producing utility, and finally, in Appendix A we invented &quot;sequory&quot; for a sequence-producing utility.</p><p>Naturally, we need to coin a symmetric term here for a channel-producing utility. So let&#39;s unsurprisingly call it a &quot;chanory&quot; (&quot;channel&quot; + &quot;factory&quot;). As an exercise for the reader, try your hand at defining a <code>channelify(..)</code> utility similar to <code>Promise.wrap(..)</code>/<code>promisify(..)</code> (Chapter 3), <code>thunkify(..)</code> (Chapter 4), and <code>ASQ.wrap(..)</code> (Appendix A).</p><p>Now consider the concurrent Ajax example using <em>asyquence</em>-flavored CSP:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ASQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span>
	<span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">var</span> url1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span> ch <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// &quot;http://some.url.1&quot;</span>

		<span class="token keyword">var</span> res1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span> <span class="token function">request</span><span class="token punctuation">(</span> url1 <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> res1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">var</span> url2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span> ch <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// &quot;http://some.url.2&quot;</span>

		<span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">var</span> res2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span> <span class="token function">request</span><span class="token punctuation">(</span> url2 <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> res1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span> ch <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// pass along results to next sequence step</span>
		ch<span class="token punctuation">.</span>buffer_size <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> res1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token constant">ASQ</span><span class="token punctuation">.</span>csp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> ch<span class="token punctuation">,</span> res2 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res1<span class="token punctuation">,</span>res2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// \`res1\` comes from &quot;http://some.url.1&quot;</span>
	<span class="token comment">// \`res2\` comes from &quot;http://some.url.2&quot;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>The message passing that trades the URL strings between the two goroutines is pretty straightforward. The first goroutine makes an Ajax request to the first URL, and that response is put onto the <code>ch</code> channel. The second goroutine makes an Ajax request to the second URL, then gets the first response <code>res1</code> off the <code>ch</code> channel. At that point, both responses <code>res1</code> and <code>res2</code> are completed and ready.</p><p>If there are any remaining values in the <code>ch</code> channel at the end of the goroutine run, they will be passed along to the next step in the sequence. So, to pass out message(s) from the final goroutine, <code>put(..)</code> them into <code>ch</code>. As shown, to avoid the blocking of those final <code>put(..)</code>s, we switch <code>ch</code> into buffering mode by setting its <code>buffer_size</code> to <code>2</code> (default: <code>0</code>).</p><p><strong>Note:</strong> See many more examples of using <em>asynquence</em>-flavored CSP here (https://gist.github.com/getify/e0d04f1f5aa24b1947ae).</p><h2 id="review" tabindex="-1"><a class="header-anchor" href="#review" aria-hidden="true">#</a> Review</h2><p>Promises and generators provide the foundational building blocks upon which we can build much more sophisticated and capable asynchrony.</p><p><em>asynquence</em> has utilities for implementing <em>iterable sequences</em>, <em>reactive sequences</em> (aka &quot;Observables&quot;), <em>concurrent coroutines</em>, and even <em>CSP goroutines</em>.</p><p>Those patterns, combined with the continuation-callback and Promise capabilities, gives <em>asynquence</em> a powerful mix of different asynchronous functionalities, all integrated in one clean async flow control abstraction: the sequence.</p>`,156);function e(p,o){return t}var u=n(a,[["render",e],["__file","apB.html.vue"]]);export{u as default};
